<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI é¢è¯•é™ªç»ƒï¼ˆJDâ†’é¢˜åº“â†’è¯­éŸ³é™ªç»ƒï¼‰</title>
  <style>
    :root{
      --bg: #f6f8ff;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: rgba(15,23,42,.10);

      --p1: #5b7cfa;   /* è“ç´«ä¸»è‰² */
      --p2: #7c5cff;   /* ç´« */
      --p3: #22c55e;   /* æˆåŠŸ */
      --p4: #f59e0b;   /* è­¦å‘Š */
      --danger: #ef4444;

      --r12: 12px;
      --r16: 16px;
      --r20: 20px;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 8px 20px rgba(15,23,42,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.20), transparent 55%),
                  radial-gradient(1000px 500px at 90% -10%, rgba(91,124,250,.18), transparent 60%),
                  var(--bg);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:20px 18px 28px}
    header{
      border-radius: 22px;
      padding: 18px 18px;
      background: linear-gradient(135deg, rgba(91,124,250,.95), rgba(124,92,255,.92));
      color:#fff;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    header:before{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width: 240px; height: 240px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%);
      transform: rotate(12deg);
    }
    .h-title{font-size:20px;font-weight:800;letter-spacing:.2px;margin:0 0 6px}
    .h-sub{margin:0;color:rgba(255,255,255,.85);font-size:13px;line-height:1.6;max-width:820px}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background:var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r20);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .card h3{
      margin:0 0 10px;
      font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .badge{
      font-size:12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(91,124,250,.10);
      color: #2747d6;
      border: 1px solid rgba(91,124,250,.18);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex: 1 1 auto}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    textarea, input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.12);
      outline:none;
      background:#fff;
      color:var(--text);
      transition: .15s ease;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(124,92,255,.45);
      box-shadow: 0 0 0 4px rgba(124,92,255,.12);
    }
    textarea{min-height:140px;resize:vertical;line-height:1.5}

    .btn{
      cursor:pointer;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color:var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:700;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(15,23,42,.06)}
    .btn:active{transform: translateY(0)}
    .btn-primary{
      border:none;
      color:#fff;
      background: linear-gradient(135deg, var(--p1), var(--p2));
    }
    .btn-ghost{
      background: rgba(91,124,250,.06);
      border: 1px solid rgba(91,124,250,.18);
      color:#2747d6;
    }
    .btn-danger{
      border:none;color:#fff;
      background: linear-gradient(135deg, #fb7185, #ef4444);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      margin-top:6px;
    }

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 10px;border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.7);
      font-size:12px;color:var(--muted);
    }
    .pill strong{color:var(--text)}
    .divider{height:1px;background:var(--line);margin:12px 0}

    /* chat */
    .chat{
      display:flex; flex-direction:column; gap:10px;
      max-height: 520px;
      overflow:auto;
      padding-right:6px;
    }
    .msg{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding:10px 12px;
      background:#fff;
    }
    .msg.me{border-color: rgba(124,92,255,.25); background: rgba(124,92,255,.06)}
    .msg .meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .who{font-weight:800;font-size:12px}
    .when{font-size:11px;color:var(--muted)}
    .msg .txt{font-size:13px;line-height:1.6;white-space:pre-wrap}

    .coach{
      margin-top:8px;
      border-radius: 16px;
      border: 1px dashed rgba(91,124,250,.35);
      background: rgba(91,124,250,.06);
      padding:10px 12px;
    }
    .scoreline{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 0}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:12px;font-weight:800;color:var(--text)}
    .bar{
      height:8px; width:100%;
      background: rgba(15,23,42,.08);
      border-radius:999px;
      overflow:hidden;
      margin-top:6px;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(91,124,250,.95), rgba(124,92,255,.95));
      border-radius:999px;
    }

    .footer-note{
      margin-top:12px;
      font-size:12px;color:var(--muted);line-height:1.5;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0b1220; color:#fff;
      padding:10px 12px; border-radius: 14px;
      box-shadow: var(--shadow);
      font-size:12px; opacity:0; pointer-events:none;
      transition:.2s ease;
      max-width: 92vw;
    }
    .toast.show{opacity:1; pointer-events:auto}
    .small{font-size:12px;color:var(--muted)}
    .right-tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <p class="h-title">AI é¢è¯•é™ªç»ƒï¼šJD â†’ é¢˜åº“ â†’ è¯­éŸ³é™ªç»ƒ</p>
      <p class="h-sub">
        å…ˆä¸Šä¼ /ç²˜è´´å²—ä½ JD è‡ªåŠ¨ç”Ÿæˆé¢è¯•é¢˜åº“ï¼Œå†è¿›å…¥é™ªç»ƒã€‚æ”¯æŒã€Œå‹å¥½/å‹åŠ›ã€ä¸¤ç§é£æ ¼ä¸ã€ŒSTAR/åœºæ™¯æ¨è¿›/é‡åŒ–è¡¨è¾¾ã€ä¸‰ç±»è®­ç»ƒç›®æ ‡ï¼Œè®­ç»ƒä¸­å¯åˆ‡æ¢ï¼ˆä¸‹ä¸€é¢˜ç”Ÿæ•ˆï¼‰ã€‚
      </p>
      <div class="row" style="margin-top:10px">
        <span class="pill"><strong>éšç§æç¤º</strong>ï¼šå°½é‡å…ˆåšè„±æ•ï¼ˆå…¬å¸å/é¡¹ç›®åï¼‰</span>
        <span class="pill"><strong>è¯­éŸ³</strong>ï¼šä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«/æ’­æŠ¥ï¼ˆä¸å…¼å®¹å¯æ‰‹åŠ¨è¾“å…¥ï¼‰</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: JD + Bank -->
      <div class="card">
        <h3>â‘  ä¸Šä¼ /ç²˜è´´ JD <span class="badge">ç”Ÿæˆé¢˜åº“</span></h3>

        <div class="field">
          <label>JD æ–‡æœ¬ï¼ˆå»ºè®®å…ˆè„±æ•ï¼‰</label>
          <textarea id="jdText" placeholder="æŠŠå²—ä½ JD ç›´æ¥ç²˜è´´åˆ°è¿™é‡Œ..."></textarea>
          <div class="row">
            <label class="btn btn-ghost" style="flex:0 0 auto;">
              <input id="jdFile" type="file" accept=".txt" style="display:none;">
              ğŸ“ å¯¼å…¥ .txt
            </label>
            <button id="btnParse" class="btn">ğŸ§© è§£æ JD</button>
            <button id="btnGenBank" class="btn btn-primary">âœ¨ ç”Ÿæˆé¢˜åº“</button>
          </div>
          <div class="hint">æ¨èæµç¨‹ï¼šè§£æ JD â†’ ç”Ÿæˆé¢˜åº“ã€‚é¢˜åº“ç”Ÿæˆåä¼šç¼“å­˜åœ¨æœ¬åœ°ï¼ˆåˆ·æ–°ä¹Ÿä¸ä¼šä¸¢ï¼‰ã€‚</div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label>é™ªç»ƒé£æ ¼ï¼ˆå¯è®­ç»ƒä¸­åˆ‡æ¢ï¼Œä¸‹ä¸€é¢˜ç”Ÿæ•ˆï¼‰</label>
            <select id="styleSel">
              <option value="friendly">å‹å¥½å¼•å¯¼</option>
              <option value="pressure">å‹åŠ›é¢è¯•</option>
            </select>
          </div>
          <div class="field">
            <label>è®­ç»ƒç›®æ ‡ï¼ˆå¯è®­ç»ƒä¸­åˆ‡æ¢ï¼Œä¸‹ä¸€é¢˜ç”Ÿæ•ˆï¼‰</label>
            <select id="goalSel">
              <option value="star">STAR ç»“æ„è¡¨è¾¾</option>
              <option value="scenario">åœºæ™¯æ¨è¿›ä¸å†³ç­–</option>
              <option value="quant">æ•°æ®é‡åŒ–ä¸ç»“æœè¡¨è¾¾</option>
            </select>
          </div>
          <div class="field">
            <label>éš¾åº¦ï¼ˆMVP å…ˆç”¨ 2ï¼‰</label>
            <select id="diffSel">
              <option value="1">1ï¼ˆæ›´å‹å¥½ï¼‰</option>
              <option value="2" selected>2ï¼ˆæ ‡å‡†ï¼‰</option>
              <option value="3">3ï¼ˆæ›´åˆé’»ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="row" style="align-items:center">
            <label class="pill" style="cursor:pointer">
              <input id="ttsToggle" type="checkbox" style="margin:0 6px 0 0;">
              <span>AI è¯­éŸ³æ’­æŠ¥</span>
            </label>
            <label class="pill" style="cursor:pointer">
              <input id="editToggle" type="checkbox" checked style="margin:0 6px 0 0;">
              <span>è¯†åˆ«æ–‡æœ¬å¯ç¼–è¾‘</span>
            </label>
          </div>
          <div class="right-tools">
            <button id="btnClear" class="btn btn-danger">ğŸ§¹ æ¸…ç©ºæœ¬åœ°ç¼“å­˜</button>
          </div>
        </div>

        <div class="divider"></div>

        <h3 style="margin-top:0">â‘¡ é¢˜åº“ä¸è¿›åº¦ <span class="badge">æœ¬åœ°ç¼“å­˜</span></h3>
        <div class="row" style="align-items:center">
          <button id="btnStart" class="btn btn-primary">â–¶ å¼€å§‹é™ªç»ƒ</button>
          <button id="btnNext" class="btn" disabled>â¡ ä¸‹ä¸€é¢˜</button>
          <span class="pill"><strong>å½“å‰é¢˜</strong> <span id="qIndex">-</span> / <span id="qTotal">-</span></span>
          <span class="pill"><strong>é¢˜å‹</strong> <span id="qType">-</span></span>
        </div>

        <div class="field" style="margin-top:10px">
          <label>å½“å‰é¢˜ç›®</label>
          <textarea id="qPrompt" readonly placeholder="é¢˜åº“ç”Ÿæˆåï¼Œç‚¹å‡»â€œå¼€å§‹é™ªç»ƒâ€è‡ªåŠ¨å‡ºé¢˜"></textarea>
          <div class="hint">æç¤ºï¼šåˆ‡æ¢é£æ ¼/ç›®æ ‡ä¼šåœ¨â€œä¸‹ä¸€é¢˜â€ç”Ÿæ•ˆï¼Œæœ¬é¢˜ä¸å˜ã€‚</div>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>é¢˜åº“æ¦‚è§ˆï¼ˆåªå±•ç¤ºå‰ 12 æ¡ï¼‰</label>
          <div id="bankPreview" class="small">æš‚æ— é¢˜åº“</div>
        </div>
      </div>

      <!-- Right: Chat -->
      <div class="card">
        <h3>â‘¢ è¯­éŸ³é™ªç»ƒ <span class="badge">é¢è¯•å®˜ + æ•™ç»ƒ</span></h3>

        <div class="row">
          <button id="btnMic" class="btn">ğŸ™ å¼€å§‹è¯­éŸ³</button>
          <button id="btnStopMic" class="btn" disabled>â¹ åœæ­¢</button>
        </div>

        <div class="field" style="margin-top:10px">
          <label>ä½ çš„å›ç­”ï¼ˆè¯­éŸ³è¯†åˆ«/æ‰‹åŠ¨è¾“å…¥ï¼‰</label>
          <textarea id="answerText" placeholder="ç‚¹å‡»â€œå¼€å§‹è¯­éŸ³â€æˆ–ç›´æ¥è¾“å…¥..."></textarea>
          <div class="row">
            <button id="btnSend" class="btn btn-primary">ğŸ“¨ å‘é€å›ç­”</button>
            <button id="btnResetChat" class="btn">â™» é‡ç½®å¯¹è¯</button>
          </div>
          <div id="sttHint" class="hint">è¯­éŸ³è¯†åˆ«ï¼šæœªå¼€å§‹</div>
        </div>

        <div class="divider"></div>

        <div class="chat" id="chat"></div>

        <div class="footer-note">
          è¯´æ˜ï¼šæœ¬ Demo ä½¿ç”¨ Vercel Serverless Function ä»£ç†è°ƒç”¨ DeepSeekï¼ŒAPI Key å­˜åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­ï¼Œä¸ä¼šæš´éœ²åœ¨å‰ç«¯ã€‚:contentReference[oaicite:2]{index=2}
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  const nowStr = () => new Date().toLocaleString();

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2200);
  }

  function safeJsonParseMaybe(str){
    try { return JSON.parse(str); } catch(e){}
    // try extract first {...} block
    const a = str.indexOf("{");
    const b = str.lastIndexOf("}");
    if(a>=0 && b>a){
      try { return JSON.parse(str.slice(a, b+1)); } catch(e){}
    }
    return null;
  }

  function speakIfEnabled(text){
    if(!$("ttsToggle").checked) return;
    if(!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-CN";
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  // -----------------------------
  // State (local cache)
  // -----------------------------
  const LS_KEY = "ai_mock_interview_bank_v1";
  const LS_CHAT = "ai_mock_interview_chat_v1";

  let jdProfile = null;
  let questionBank = null;
  let currentQuestion = null;
  let qCursor = 0;

  let chatLog = []; // for UI only
  let historySummary = ""; // MVP å…ˆç©ºï¼Œåç»­å¯åšæ‘˜è¦å‹ç¼©

  const WEIGHTS = {
    star:      { behavior_star: 0.65, scenario_case: 0.25, skill_check: 0.10 },
    scenario:  { behavior_star: 0.25, scenario_case: 0.65, skill_check: 0.10 },
    quant:     { behavior_star: 0.30, scenario_case: 0.30, skill_check: 0.40 }
  };

  const SCORE_WEIGHTS = {
    star:     { clarity:0.15, structure:0.35, evidence:0.20, fit:0.15, impact:0.15 },
    scenario: { clarity:0.15, structure:0.20, evidence:0.20, fit:0.25, impact:0.20 },
    quant:    { clarity:0.15, structure:0.15, evidence:0.35, fit:0.15, impact:0.20 }
  };

  function sessionConfig(){
    return {
      style: $("styleSel").value,
      goal: $("goalSel").value,
      difficulty: Number($("diffSel").value),
      feedback_mode: "micro",
      language: "zh",
      apply_timing: "next_turn"
    };
  }

  function saveBank(){
    localStorage.setItem(LS_KEY, JSON.stringify({ jdProfile, questionBank }));
  }
  function loadBank(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const obj = safeJsonParseMaybe(raw);
    if(obj && obj.questionBank){
      jdProfile = obj.jdProfile || null;
      questionBank = obj.questionBank;
    }
  }
  function saveChat(){
    localStorage.setItem(LS_CHAT, JSON.stringify({ chatLog }));
  }
  function loadChat(){
    const raw = localStorage.getItem(LS_CHAT);
    if(!raw) return;
    const obj = safeJsonParseMaybe(raw);
    if(obj && Array.isArray(obj.chatLog)) chatLog = obj.chatLog;
  }

  function renderBankPreview(){
    if(!questionBank || !Array.isArray(questionBank.questions)){
      $("bankPreview").textContent = "æš‚æ— é¢˜åº“";
      $("qTotal").textContent = "-";
      return;
    }
    $("qTotal").textContent = questionBank.questions.length;
    const list = questionBank.questions.slice(0,12).map((q,i)=>{
      return `${i+1}. [${q.type}] ${q.prompt}`;
    }).join("\n");
    $("bankPreview").textContent = list;
  }

  function renderChat(){
    const box = $("chat");
    box.innerHTML = "";
    chatLog.forEach(m=>{
      const div = document.createElement("div");
      div.className = "msg " + (m.role === "me" ? "me" : "");
      div.innerHTML = `
        <div class="meta">
          <div class="who">${m.role === "me" ? "ä½ " : (m.role === "interviewer" ? "é¢è¯•å®˜" : "ç³»ç»Ÿ")}</div>
          <div class="when">${m.when || ""}</div>
        </div>
        <div class="txt"></div>
      `;
      div.querySelector(".txt").textContent = m.text || "";

      if(m.coach){
        const c = m.coach;
        const coach = document.createElement("div");
        coach.className = "coach";
        coach.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
            <div style="font-weight:900;font-size:12px">æ•™ç»ƒç‚¹è¯„</div>
            <span class="pill"><strong>æ€»åˆ†</strong> ${c.total_score ?? "-"} / 100</span>
          </div>
          <div class="bar"><i style="width:${Math.max(0, Math.min(100, c.total_score||0))}%"></i></div>
          <div class="scoreline">
            <span class="k">äº®ç‚¹ï¼š</span><span class="v">${c.strength || "-"}</span>
          </div>
          <div class="scoreline">
            <span class="k">æ”¹è¿›ï¼š</span><span class="v">${c.improve || "-"}</span>
          </div>
          <div class="scoreline">
            <span class="k">ç¤ºèŒƒï¼š</span><span class="v">${c.one_sentence_demo || "-"}</span>
          </div>
        `;
        div.appendChild(coach);
      }

      box.appendChild(div);
    });

    box.scrollTop = box.scrollHeight;
    saveChat();
  }

  // -----------------------------
  // Question selection
  // -----------------------------
  function chooseNextQuestion(){
    if(!questionBank || !questionBank.questions?.length) return null;
    const goal = $("goalSel").value;
    const weights = WEIGHTS[goal] || WEIGHTS.star;

    // filter by difficulty (Â±1)
    const diff = Number($("diffSel").value);
    const pool = questionBank.questions.filter(q=>{
      const d = Number(q.difficulty || 2);
      return Math.abs(d - diff) <= 1 && q.type !== "closing_reverse";
    });

    // group by type
    const groups = {
      behavior_star: pool.filter(q=>q.type==="behavior_star"),
      scenario_case: pool.filter(q=>q.type==="scenario_case"),
      skill_check: pool.filter(q=>q.type==="skill_check"),
    };

    function pickByWeight(){
      const r = Math.random();
      const keys = Object.keys(weights);
      let acc = 0;
      for(const k of keys){
        acc += weights[k];
        if(r <= acc) return k;
      }
      return keys[0];
    }

    for(let tries=0; tries<6; tries++){
      const t = pickByWeight();
      const arr = groups[t] || [];
      if(arr.length){
        const q = arr[Math.floor(Math.random()*arr.length)];
        return q;
      }
    }
    // fallback
    return pool[Math.floor(Math.random()*pool.length)] || questionBank.questions[0];
  }

  function applyQuestion(q){
    currentQuestion = q;
    $("qPrompt").value = q?.prompt || "";
    $("qType").textContent = q?.type || "-";
    $("qIndex").textContent = String(++qCursor);
    $("btnNext").disabled = false;
  }

  // -----------------------------
  // API calls
  // -----------------------------
  async function apiCall(action, payload){
    const res = await fetch("/api/deepseek", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, payload })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.ok){
      throw new Error(data.error || "è¯·æ±‚å¤±è´¥");
    }
    return data.data;
  }

  // -----------------------------
  // JD file import
  // -----------------------------
  $("jdFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    $("jdText").value = text;
    toast("å·²å¯¼å…¥ JD æ–‡æœ¬");
  });

  // -----------------------------
  // Buttons: parse JD / generate bank
  // -----------------------------
  $("btnParse").addEventListener("click", async ()=>{
    const jd = $("jdText").value.trim();
    if(!jd){ toast("è¯·å…ˆç²˜è´´ JD"); return; }
    $("btnParse").disabled = true;
    try{
      toast("æ­£åœ¨è§£æ JD...");
      const data = await apiCall("parse_jd", { jd_text: jd });
      jdProfile = data;
      saveBank();
      toast("JD è§£æå®Œæˆ");
    }catch(err){
      console.error(err);
      toast("è§£æå¤±è´¥ï¼š" + err.message);
    }finally{
      $("btnParse").disabled = false;
    }
  });

  $("btnGenBank").addEventListener("click", async ()=>{
    const jd = $("jdText").value.trim();
    if(!jd){ toast("è¯·å…ˆç²˜è´´ JD"); return; }
    $("btnGenBank").disabled = true;
    try{
      toast("æ­£åœ¨ç”Ÿæˆé¢˜åº“...");
      const data = await apiCall("generate_bank", {
        jd_text: jd,
        jd_profile: jdProfile || null
      });
      questionBank = data;
      qCursor = 0;
      saveBank();
      renderBankPreview();
      toast("é¢˜åº“ç”Ÿæˆå®Œæˆï¼ˆå·²ç¼“å­˜ï¼‰");
    }catch(err){
      console.error(err);
      toast("ç”Ÿæˆå¤±è´¥ï¼š" + err.message);
    }finally{
      $("btnGenBank").disabled = false;
    }
  });

  // -----------------------------
  // Practice controls
  // -----------------------------
  $("btnStart").addEventListener("click", ()=>{
    if(!questionBank?.questions?.length){
      toast("è¯·å…ˆç”Ÿæˆé¢˜åº“");
      return;
    }
    qCursor = 0;
    const q = chooseNextQuestion();
    applyQuestion(q);
    chatLog.push({ role:"system", when: nowStr(), text:"é™ªç»ƒå¼€å§‹ã€‚è¯·å…ˆå›ç­”å½“å‰é¢˜ç›®ã€‚ä½ å¯ä»¥ç”¨è¯­éŸ³æˆ–æ–‡å­—è¾“å…¥ã€‚" });
    chatLog.push({ role:"interviewer", when: nowStr(), text: q.prompt });
    renderChat();
    speakIfEnabled(q.prompt);
    toast("å·²å‡ºé¢˜");
  });

  $("btnNext").addEventListener("click", ()=>{
    if(!questionBank?.questions?.length){ toast("æš‚æ— é¢˜åº“"); return; }
    const q = chooseNextQuestion();
    applyQuestion(q);
    chatLog.push({ role:"interviewer", when: nowStr(), text: "ä¸‹ä¸€é¢˜ï¼š" + q.prompt });
    renderChat();
    speakIfEnabled(q.prompt);
  });

  $("btnResetChat").addEventListener("click", ()=>{
    chatLog = [];
    renderChat();
    toast("å¯¹è¯å·²é‡ç½®");
  });

  $("btnClear").addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_CHAT);
    jdProfile = null;
    questionBank = null;
    currentQuestion = null;
    qCursor = 0;
    $("qPrompt").value = "";
    $("qType").textContent = "-";
    $("qIndex").textContent = "-";
    $("qTotal").textContent = "-";
    $("bankPreview").textContent = "æš‚æ— é¢˜åº“";
    chatLog = [];
    renderChat();
    toast("æœ¬åœ°ç¼“å­˜å·²æ¸…ç©º");
  });

  // -----------------------------
  // Send answer
  // -----------------------------
  $("btnSend").addEventListener("click", async ()=>{
    if(!currentQuestion){ toast("è¯·å…ˆå¼€å§‹é™ªç»ƒå‡ºé¢˜"); return; }
    const answer = $("answerText").value.trim();
    if(!answer){ toast("è¯·å…ˆè¾“å…¥å›ç­”"); return; }

    const cfg = sessionConfig();
    chatLog.push({ role:"me", when: nowStr(), text: answer });
    renderChat();

    $("btnSend").disabled = true;
    try{
      toast("AI æ­£åœ¨è¿½é—®ä¸ç‚¹è¯„...");
      const data = await apiCall("chat", {
        session_config: cfg,
        question: currentQuestion,
        user_answer: answer,
        history_summary: historySummary,
        rubric_weights: SCORE_WEIGHTS[cfg.goal] || SCORE_WEIGHTS.star
      });

      // data expected: { interviewer_reply, coach_feedback, next_focus, next_action }
      const interviewer = data?.interviewer_reply || "ï¼ˆæœªç”Ÿæˆé¢è¯•å®˜å›å¤ï¼‰";
      const coach = data?.coach_feedback || null;

      chatLog.push({
        role:"interviewer",
        when: nowStr(),
        text: interviewer,
        coach
      });
      renderChat();
      speakIfEnabled(interviewer);

      // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆä¿ç•™å¯ç¼–è¾‘å¼€å…³ï¼šMVP å…ˆç›´æ¥æ¸…ç©ºï¼‰
      $("answerText").value = "";
    }catch(err){
      console.error(err);
      toast("è¯·æ±‚å¤±è´¥ï¼š" + err.message);
    }finally{
      $("btnSend").disabled = false;
    }
  });

  // -----------------------------
  // Speech Recognition (Web Speech API)
  // -----------------------------
  let recognition = null;
  let recognizing = false;

  function setupSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šå½“å‰æµè§ˆå™¨ä¸æ”¯æŒï¼ˆè¯·æ‰‹åŠ¨è¾“å…¥ï¼‰";
      $("btnMic").disabled = true;
      return;
    }
    recognition = new SR();
    recognition.lang = "zh-CN";
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onstart = ()=>{
      recognizing = true;
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šè¿›è¡Œä¸­â€¦";
      $("btnMic").disabled = true;
      $("btnStopMic").disabled = false;
    };

    recognition.onerror = (e)=>{
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šé”™è¯¯ " + (e.error || "");
      recognizing = false;
      $("btnMic").disabled = false;
      $("btnStopMic").disabled = true;
    };

    recognition.onend = ()=>{
      recognizing = false;
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šå·²åœæ­¢";
      $("btnMic").disabled = false;
      $("btnStopMic").disabled = true;
    };

    recognition.onresult = (e)=>{
      let finalText = "";
      let interim = "";
      for(let i=e.resultIndex;i<e.results.length;i++){
        const t = e.results[i][0].transcript;
        if(e.results[i].isFinal) finalText += t;
        else interim += t;
      }
      const allowEdit = $("editToggle").checked;
      if(allowEdit){
        // å¯ç¼–è¾‘ï¼šæŠŠç»“æœè¿½åŠ åˆ°æ–‡æœ¬æ¡†
        $("answerText").value = ($("answerText").value + " " + finalText + interim).trim();
      }else{
        // ä¸å¯ç¼–è¾‘ï¼šç›´æ¥è¦†ç›–ï¼ˆæ›´åƒå®æ—¶å¬å†™ï¼‰
        $("answerText").value = (finalText + interim).trim();
      }
    };
  }

  $("btnMic").addEventListener("click", ()=>{
    if(!recognition) return;
    try{ recognition.start(); }catch(e){}
  });
  $("btnStopMic").addEventListener("click", ()=>{
    if(!recognition) return;
    try{ recognition.stop(); }catch(e){}
  });

  // -----------------------------
  // init
  // -----------------------------
  (function init(){
    loadBank();
    loadChat();
    renderBankPreview();
    renderChat();
    setupSTT();

    if(questionBank?.questions?.length){
      $("qTotal").textContent = questionBank.questions.length;
    }
  })();
</script>
</body>
</html>
