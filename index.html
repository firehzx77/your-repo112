<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI é¢è¯•é™ªç»ƒï¼ˆè¯­éŸ³äº’åŠ¨ MVPï¼‰</title>
  <style>
    :root{
      --bg: #f6f8ff;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: rgba(15,23,42,.10);

      --p1: #5b7cfa;   /* è“ç´«ä¸»è‰² */
      --p2: #7c5cff;   /* ç´« */
      --p3: #22c55e;   /* æˆåŠŸ */
      --p4: #f59e0b;   /* è­¦å‘Š */
      --danger: #ef4444;

      --r12: 12px;
      --r16: 16px;
      --r20: 20px;

      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 8px 20px rgba(15,23,42,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.20), transparent 55%),
        radial-gradient(1000px 500px at 90% -10%, rgba(91,124,250,.18), transparent 60%),
        var(--bg);
    }

    .wrap{max-width:1160px;margin:0 auto;padding:20px 18px 28px}
    header{
      border-radius: 22px;
      padding: 18px 18px;
      background: linear-gradient(135deg, rgba(91,124,250,.95), rgba(124,92,255,.92));
      color:#fff;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    header:before{
      content:"";
      position:absolute; inset:-70px -70px auto auto;
      width: 260px; height: 260px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 62%);
      transform: rotate(12deg);
    }
    .h-title{font-size:20px;font-weight:900;letter-spacing:.2px;margin:0 0 6px}
    .h-sub{margin:0;color:rgba(255,255,255,.85);font-size:13px;line-height:1.6;max-width:920px}
    .h-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.16);
      font-size:12px;color:rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
    }
    .pill strong{color:#fff}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background:var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r20);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .card h3{
      margin:0 0 10px;
      font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .badge{
      font-size:12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(91,124,250,.10);
      color: #2747d6;
      border: 1px solid rgba(91,124,250,.18);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex: 1 1 auto}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    textarea, input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.12);
      outline:none;
      background:#fff;
      color:var(--text);
      transition: .15s ease;
    }
    textarea:focus, input:focus, select:focus{
      border-color: rgba(124,92,255,.45);
      box-shadow: 0 0 0 4px rgba(124,92,255,.12);
    }
    textarea{min-height:120px;resize:vertical;line-height:1.5}

    .btn{
      cursor:pointer;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color:var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:800;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(15,23,42,.06)}
    .btn:active{transform: translateY(0)}
    .btn-primary{
      border:none;
      color:#fff;
      background: linear-gradient(135deg, var(--p1), var(--p2));
    }
    .btn-ghost{
      background: rgba(91,124,250,.06);
      border: 1px solid rgba(91,124,250,.18);
      color:#2747d6;
    }
    .btn-danger{
      border:none;color:#fff;
      background: linear-gradient(135deg, #fb7185, #ef4444);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      margin-top:6px;
    }

    .divider{height:1px;background:var(--line);margin:12px 0}

    /* ---- Stage (scene + avatars) ---- */
    .stage{
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      overflow:hidden;
      position: relative;
      min-height: 240px;
      background: linear-gradient(135deg, rgba(91,124,250,.12), rgba(124,92,255,.10));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
    }

    .stage[data-scene="interview_room"]{
      background:
        radial-gradient(800px 280px at 20% 10%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, rgba(255,193,7,.12), rgba(91,124,250,.10));
    }
    .stage[data-scene="meeting_room"]{
      background:
        radial-gradient(700px 260px at 80% 0%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, rgba(34,197,94,.10), rgba(124,92,255,.10));
    }
    .stage[data-scene="open_office"]{
      background:
        radial-gradient(700px 260px at 30% 0%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        repeating-linear-gradient(0deg, rgba(15,23,42,.04) 0, rgba(15,23,42,.04) 1px, transparent 1px, transparent 14px),
        linear-gradient(135deg, rgba(91,124,250,.10), rgba(124,92,255,.08));
    }
    .stage[data-scene="online_call"]{
      background:
        radial-gradient(700px 260px at 50% 0%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
        repeating-linear-gradient(90deg, rgba(124,92,255,.10) 0, rgba(124,92,255,.10) 1px, transparent 1px, transparent 18px),
        linear-gradient(135deg, rgba(91,124,250,.10), rgba(124,92,255,.10));
    }

    .stage::after{
      content:"";
      position:absolute; inset:auto 0 0 0;
      height: 60px;
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.55));
      pointer-events:none;
    }

    .avatars{
      position:absolute; inset: 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      align-items:end;
      padding: 18px 14px 12px;
    }

    .avatarWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap: 8px;
      min-height: 220px;
    }

    .nameTag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(15,23,42,.10);
      color: var(--text);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .nameTag .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(15,23,42,.22);
    }
    .nameTag .dot.live{ background: linear-gradient(135deg, #22c55e, #16a34a); }
    .nameTag .dot.talk{ background: linear-gradient(135deg, #f59e0b, #f97316); }

    .avatar{
      width: 128px;
      height: 168px;
      position: relative;
      filter: drop-shadow(0 14px 22px rgba(15,23,42,.12));
      animation: floaty 3.8s ease-in-out infinite;
    }
    .avatar.small{
      width: 116px;
      height: 152px;
      opacity: .98;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-6px); }
    }

    /* body */
    .avatar .torso{
      position:absolute; left:50%; bottom: 0;
      width: 112px; height: 98px;
      transform: translateX(-50%);
      border-radius: 28px 28px 18px 18px;
      background: linear-gradient(135deg, rgba(91,124,250,.95), rgba(124,92,255,.88));
      border: 1px solid rgba(255,255,255,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22);
    }
    .avatar.me .torso{
      background: linear-gradient(135deg, rgba(34,197,94,.85), rgba(91,124,250,.70));
    }

    /* head */
    .avatar .head{
      position:absolute; left:50%; bottom: 76px;
      width: 96px; height: 96px;
      transform: translateX(-50%);
      border-radius: 28px;
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(255,255,255,.82));
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 14px 26px rgba(15,23,42,.10);
    }

    /* eyes */
    .eye{
      position:absolute; top: 34px;
      width: 12px; height: 12px;
      border-radius: 99px;
      background: rgba(15,23,42,.82);
      animation: blink 4.5s infinite;
    }
    .eye.left{ left: 28px; }
    .eye.right{ right: 28px; }
    @keyframes blink{
      0%, 92%, 100%{ transform: scaleY(1); }
      94%, 96%{ transform: scaleY(.12); }
    }

    /* mouth */
    .mouth{
      position:absolute; left:50%; top: 62px;
      width: 34px; height: 14px;
      transform: translateX(-50%);
      border-bottom: 3px solid rgba(15,23,42,.65);
      border-radius: 0 0 18px 18px;
      opacity:.95;
    }

    /* speaking animation */
    .avatar.talking .mouth{
      border-bottom-width: 4px;
      animation: speak 0.22s infinite alternate;
    }
    @keyframes speak{
      from{ width: 26px; height: 10px; opacity:.75; }
      to{ width: 40px; height: 16px; opacity:.98; }
    }

    /* pressure style => more "stern" mouth */
    .avatar.stern .mouth{
      border-radius: 18px 18px 0 0;
      border-bottom: none;
      border-top: 3px solid rgba(15,23,42,.65);
      top: 66px;
    }

    /* subtle particles */
    .spark{
      position:absolute;
      width: 8px; height: 8px;
      border-radius: 99px;
      background: rgba(255,255,255,.55);
      opacity:.9;
      animation: drift 5.6s linear infinite;
      filter: blur(.2px);
    }
    @keyframes drift{
      0%{ transform: translateY(30px) translateX(0); opacity:.0 }
      12%{ opacity:.75 }
      60%{ opacity:.55 }
      100%{ transform: translateY(-220px) translateX(22px); opacity:0 }
    }

    /* ---- chat ---- */
    .chat{
      display:flex; flex-direction:column; gap:10px;
      max-height: 520px;
      overflow:auto;
      padding-right:6px;
    }
    .msg{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding:10px 12px;
      background:#fff;
    }
    .msg.me{border-color: rgba(124,92,255,.25); background: rgba(124,92,255,.06)}
    .msg .meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .who{font-weight:900;font-size:12px}
    .when{font-size:11px;color:var(--muted)}
    .msg .txt{font-size:13px;line-height:1.6;white-space:pre-wrap}

    .coach{
      margin-top:8px;
      border-radius: 16px;
      border: 1px dashed rgba(91,124,250,.35);
      background: rgba(91,124,250,.06);
      padding:10px 12px;
    }
    .bar{
      height:8px; width:100%;
      background: rgba(15,23,42,.08);
      border-radius:999px;
      overflow:hidden;
      margin-top:6px;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(91,124,250,.95), rgba(124,92,255,.95));
      border-radius:999px;
    }
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:12px;font-weight:900;color:var(--text)}
    .scoreline{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 0}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0b1220; color:#fff;
      padding:10px 12px; border-radius: 14px;
      box-shadow: var(--shadow);
      font-size:12px; opacity:0; pointer-events:none;
      transition:.2s ease;
      max-width: 92vw;
    }
    .toast.show{opacity:1; pointer-events:auto}

    .small{font-size:12px;color:var(--muted)}
    .right-tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .miniCard{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      padding:10px 12px;
      background: rgba(255,255,255,.70);
    }

    .progress{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .progPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.72);
      font-size:12px; color: var(--muted);
    }
    .progPill strong{color:var(--text)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <p class="h-title">AI é¢è¯•é™ªç»ƒï¼ˆè¯­éŸ³äº’åŠ¨ MVPï¼‰</p>
      <p class="h-sub">
        é€‰æ‹©å²—ä½ä¸é™ªç»ƒè§’è‰²ï¼ˆé¢è¯•å®˜ç±»å‹ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ 3-5 ä¸ªé¢è¯•é—®é¢˜å¹¶è¿›å…¥è¯­éŸ³é™ªç»ƒã€‚æ¯æ¬¡å›ç­”åä¼šå³æ—¶è¿½é—®/ç‚¹è¯„ï¼Œå¹¶æ ¹æ®è¡¨ç°åŠ¨æ€è°ƒæ•´ä¸‹ä¸€æ­¥ã€‚
      </p>
      <div class="h-pills">
        <span class="pill"><strong>MVP</strong>ï¼šå†…ç½® 8 ä¸ªå¸¸è§å²—ä½</span>
        <span class="pill"><strong>åœºæ™¯</strong>ï¼šé¢è¯•å®¤ / ä¼šè®®å®¤ / å¼€æ”¾åŠå…¬ / çº¿ä¸Šé¢è¯•</span>
        <span class="pill"><strong>è¯­éŸ³</strong>ï¼šæµè§ˆå™¨è¯­éŸ³è¯†åˆ« + å¯é€‰ AI æ’­æŠ¥</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: setup + stage -->
      <div class="card">
        <h3>â‘  é€‰æ‹©å²—ä½ä¸é™ªç»ƒè§’è‰² <span class="badge">3-5é¢˜è‡ªåŠ¨ç”Ÿæˆ</span></h3>

        <div class="row">
          <div class="field">
            <label>å²—ä½ï¼ˆå€™é€‰äººï¼‰</label>
            <select id="roleSel"></select>
          </div>
          <div class="field">
            <label>é¢è¯•å®˜ç±»å‹ï¼ˆä¼šå½±å“é™ªç»ƒè§’è‰²ä¸è¯æœ¯ï¼‰</label>
            <select id="interviewerSel"></select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>é™ªç»ƒé£æ ¼ï¼ˆfriendly/pressureï¼‰</label>
            <select id="styleSel">
              <option value="friendly">å‹å¥½å¼•å¯¼</option>
              <option value="pressure">å‹åŠ›é¢è¯•</option>
            </select>
          </div>
          <div class="field">
            <label>è®­ç»ƒç›®æ ‡ï¼ˆstar/scenario/quantï¼‰</label>
            <select id="goalSel">
              <option value="star">STAR ç»“æ„è¡¨è¾¾</option>
              <option value="scenario">åœºæ™¯æ¨è¿›ä¸å†³ç­–</option>
              <option value="quant">æ•°æ®é‡åŒ–ä¸ç»“æœè¡¨è¾¾</option>
            </select>
          </div>
          <div class="field">
            <label>åœºåœ°è®¾å®š</label>
            <select id="sceneSel">
              <option value="interview_room">é¢è¯•å®¤ï¼ˆæ­£å¼ï¼‰</option>
              <option value="meeting_room">ä¼šè®®å®¤ï¼ˆä¸šåŠ¡å¤ç›˜ï¼‰</option>
              <option value="open_office">å¼€æ”¾åŠå…¬ï¼ˆå¿«èŠ‚å¥ï¼‰</option>
              <option value="online_call">çº¿ä¸Šé¢è¯•ï¼ˆè§†é¢‘é€šè¯ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="row" style="align-items:center">
            <label class="pill" style="cursor:pointer">
              <input id="ttsToggle" type="checkbox" style="margin:0 6px 0 0;">
              <span>AI è¯­éŸ³æ’­æŠ¥</span>
            </label>
            <label class="pill" style="cursor:pointer">
              <input id="autoSendToggle" type="checkbox" style="margin:0 6px 0 0;">
              <span>åœæ­¢å½•éŸ³åè‡ªåŠ¨å‘é€</span>
            </label>
          </div>
          <div class="right-tools">
            <button id="btnResetAll" class="btn btn-danger">ğŸ§¹ é‡ç½®ä¼šè¯</button>
          </div>
        </div>

        <div class="divider"></div>

        <h3 style="margin-top:0">â‘¡ åœºæ™¯èˆå° <span class="badge">äººç‰©åŠ¨ç”»</span></h3>

        <div class="stage" id="stage" data-scene="interview_room">
          <!-- particles -->
          <div class="spark" style="left:12%; bottom:20px; animation-delay:0s"></div>
          <div class="spark" style="left:28%; bottom:8px; animation-delay:1.1s"></div>
          <div class="spark" style="left:52%; bottom:12px; animation-delay:2.2s"></div>
          <div class="spark" style="left:76%; bottom:6px; animation-delay:.7s"></div>
          <div class="spark" style="left:88%; bottom:16px; animation-delay:1.7s"></div>

          <div class="avatars">
            <div class="avatarWrap">
              <div class="nameTag">
                <span class="dot" id="dotInterviewer"></span>
                <span id="nameInterviewer">é¢è¯•å®˜</span>
              </div>
              <div class="avatar small" id="avatarInterviewer">
                <div class="head">
                  <div class="eye left"></div>
                  <div class="eye right"></div>
                  <div class="mouth"></div>
                </div>
                <div class="torso"></div>
              </div>
            </div>

            <div class="avatarWrap">
              <div class="nameTag">
                <span class="dot" id="dotMe"></span>
                <span id="nameMe">ä½ ï¼ˆå€™é€‰äººï¼‰</span>
              </div>
              <div class="avatar me" id="avatarMe">
                <div class="head">
                  <div class="eye left"></div>
                  <div class="eye right"></div>
                  <div class="mouth"></div>
                </div>
                <div class="torso"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <h3 style="margin-top:0">â‘¢ é¢˜ç›®ä¸è¿›åº¦ <span class="badge">3-5é¢˜</span></h3>

        <div class="progress">
          <div class="row" style="align-items:center">
            <button id="btnStart" class="btn btn-primary">â–¶ å¼€å§‹é™ªç»ƒï¼ˆç”Ÿæˆé—®é¢˜ï¼‰</button>
            <button id="btnNextQ" class="btn" disabled>â¡ è·³åˆ°ä¸‹ä¸€é¢˜</button>
          </div>
          <div class="row" style="align-items:center;justify-content:flex-end">
            <span class="progPill"><strong>å½“å‰é¢˜</strong> <span id="qIndex">-</span> / <span id="qTotal">-</span></span>
            <span class="progPill"><strong>å¾…ç”Ÿæ•ˆ</strong> <span id="pendingHint">æ— </span></span>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="miniCard" style="flex:1">
            <div class="small" style="font-weight:900;color:var(--text)">å½“å‰é—®é¢˜</div>
            <div id="currentQuestion" style="margin-top:6px; font-size:13px; line-height:1.65; white-space:pre-wrap; color:var(--text)">å°šæœªå¼€å§‹</div>
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>é—®é¢˜åˆ—è¡¨ï¼ˆç³»ç»Ÿç”Ÿæˆï¼‰</label>
          <textarea id="questionList" readonly placeholder="ç‚¹å‡»â€œå¼€å§‹é™ªç»ƒâ€åè‡ªåŠ¨ç”Ÿæˆ 3-5 ä¸ªé—®é¢˜"></textarea>
          <div class="hint">æç¤ºï¼šé™ªç»ƒä¼šæ ¹æ®ä½ çš„å›ç­”å†³å®šâ€œè¿½é—®â€è¿˜æ˜¯â€œè¿›å…¥ä¸‹ä¸€é¢˜â€ã€‚ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨â€œè·³åˆ°ä¸‹ä¸€é¢˜â€ã€‚</div>
        </div>
      </div>

      <!-- Right: voice + chat -->
      <div class="card">
        <h3>â‘£ è¯­éŸ³äº’åŠ¨ <span class="badge">æŒ‰ä½è¯´è¯æ›´ç¨³</span></h3>

        <div class="row">
          <button id="btnHoldTalk" class="btn btn-primary">ğŸ™ æŒ‰ä½è¯´è¯</button>
          <button id="btnStop" class="btn" disabled>â¹ åœæ­¢</button>
          <button id="btnSend" class="btn">ğŸ“¨ å‘é€å›ç­”</button>
        </div>

        <div class="field" style="margin-top:10px">
          <label>ä½ çš„å›ç­”ï¼ˆè¯­éŸ³è¯†åˆ«åå¯ç¼–è¾‘ï¼‰</label>
          <textarea id="answerText" placeholder="æŒ‰ä½è¯´è¯æˆ–ç›´æ¥è¾“å…¥..."></textarea>
          <div id="sttHint" class="hint">è¯­éŸ³è¯†åˆ«ï¼šæœªå¼€å§‹</div>
        </div>

        <div class="divider"></div>

        <h3 style="margin-top:0">â‘¤ å¯¹è¯è®°å½• <span class="badge">é¢è¯•å®˜ + æ•™ç»ƒ</span></h3>
        <div class="chat" id="chat"></div>

        <div class="hint">
          è¯´æ˜ï¼šæœ¬ MVP ç”¨â€œè¯­éŸ³è¯†åˆ« â†’ æ–‡æœ¬ â†’ DeepSeek å¯¹è¯â€å®ç°è‡ªé€‚åº”è¿½é—®ä¸ç‚¹è¯„ï¼›å¦‚éœ€â€œå®æ—¶æ‰“æ–­å¼å£è¯­å¯¹è¯/æµå¼è¯­éŸ³å¤§æ¨¡å‹â€ï¼Œéœ€è¦æ¥å…¥æ”¯æŒæµå¼ ASR/TTS çš„å®æ—¶è¯­éŸ³æ–¹æ¡ˆï¼ˆåç»­å¯æ‰©å±•ï¼‰ã€‚
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  const $ = (id) => document.getElementById(id);
  const toastEl = $("toast");
  const nowStr = () => new Date().toLocaleString();

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2200);
  }

  function speakIfEnabled(text){
    if(!$("ttsToggle").checked) return;
    if(!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-CN";

    u.onstart = () => setInterviewerTalking(true);
    u.onend = () => setInterviewerTalking(false);
    u.onerror = () => setInterviewerTalking(false);

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  function setInterviewerTalking(on){
    $("avatarInterviewer").classList.toggle("talking", !!on);
    $("dotInterviewer").classList.toggle("talk", !!on);
  }
  function setMeLive(on){
    $("dotMe").classList.toggle("live", !!on);
  }

  function setStern(on){
    $("avatarInterviewer").classList.toggle("stern", !!on);
  }

  function normalizeSpace(s){
    return String(s || "").replace(/\s+/g, " ").trim();
  }

  // Dedup overlap to avoid repeated transcript chunks
  function appendWithOverlap(base, addition){
    base = normalizeSpace(base);
    addition = normalizeSpace(addition);
    if(!addition) return base;
    if(!base) return addition;
    if(base.endsWith(addition)) return base;

    const max = Math.min(base.length, addition.length);
    for(let k=max; k>8; k--){ // only meaningful overlap
      if(base.slice(-k) === addition.slice(0,k)){
        return normalizeSpace(base + " " + addition.slice(k));
      }
    }
    // if addition already contained in last 50 chars, avoid
    const tail = base.slice(-50);
    if(tail.includes(addition)) return base;
    return normalizeSpace(base + " " + addition);
  }

  // -----------------------------
  // Role presets (8 jobs MVP)
  // -----------------------------
  const ROLES = [
    {
      key: "sales_mgr",
      label: "é”€å”®ç»ç†",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆä»·å€¼è§‚&åŠ¨æœºï¼‰" },
        { key:"hiring_mgr", label:"é”€å”®æ€»ç›‘ï¼ˆä¸šç»©&æ‰“æ³•ï¼‰" },
        { key:"exec", label:"VP/é«˜ç®¡ï¼ˆæˆ˜ç•¥&å¢é•¿ï¼‰" }
      ]
    },
    {
      key: "product_mgr",
      label: "äº§å“ç»ç†",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆåä½œ&å¿ƒæ™ºï¼‰" },
        { key:"hiring_mgr", label:"äº§å“è´Ÿè´£äººï¼ˆæ–¹æ³•&é—­ç¯ï¼‰" },
        { key:"exec", label:"ä¸šåŠ¡è´Ÿè´£äººï¼ˆå•†ä¸š&å¢é•¿ï¼‰" }
      ]
    },
    {
      key: "ops",
      label: "è¿è¥ä¸“å‘˜/è¿è¥ç»ç†",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆæ‰§è¡Œ&å­¦ä¹ ï¼‰" },
        { key:"hiring_mgr", label:"è¿è¥è´Ÿè´£äººï¼ˆæŒ‡æ ‡&å¢é•¿ï¼‰" },
        { key:"exec", label:"GM/é«˜ç®¡ï¼ˆå…¨å±€&ROIï¼‰" }
      ]
    },
    {
      key: "hrbp",
      label: "HRBP",
      interviewer_options: [
        { key:"hrbp", label:"HRDï¼ˆä¸“ä¸š&æ–¹æ³•ï¼‰" },
        { key:"hiring_mgr", label:"ä¸šåŠ¡è´Ÿè´£äººï¼ˆä¸šåŠ¡ç†è§£&æ¨åŠ¨åŠ›ï¼‰" },
        { key:"exec", label:"æ€»ç»ç†ï¼ˆç»„ç»‡&æ–‡åŒ–ï¼‰" }
      ]
    },
    {
      key: "project_mgr",
      label: "é¡¹ç›®ç»ç†",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆåä½œ&å‹åŠ›ï¼‰" },
        { key:"hiring_mgr", label:"äº¤ä»˜è´Ÿè´£äººï¼ˆè®¡åˆ’&é£é™©ï¼‰" },
        { key:"exec", label:"CTO/é«˜ç®¡ï¼ˆå…¨å±€&èµ„æºï¼‰" }
      ]
    },
    {
      key: "data_analyst",
      label: "æ•°æ®åˆ†æå¸ˆ",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆæ²Ÿé€š&åŠ¨æœºï¼‰" },
        { key:"hiring_mgr", label:"æ•°æ®è´Ÿè´£äººï¼ˆå£å¾„&æ´å¯Ÿï¼‰" },
        { key:"exec", label:"ä¸šåŠ¡è´Ÿè´£äººï¼ˆä»·å€¼&å†³ç­–ï¼‰" }
      ]
    },
    {
      key: "customer_service",
      label: "å®¢æœä¸»ç®¡/å®¢æœä¸“å‘˜",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆæœåŠ¡å¿ƒæ€ï¼‰" },
        { key:"hiring_mgr", label:"å®¢æœç»ç†ï¼ˆæµç¨‹&æ»¡æ„åº¦ï¼‰" },
        { key:"exec", label:"è¿è¥è´Ÿè´£äººï¼ˆä½“éªŒ&æˆæœ¬ï¼‰" }
      ]
    },
    {
      key: "mfg_supervisor",
      label: "ç”Ÿäº§ä¸»ç®¡/ç­ç»„é•¿",
      interviewer_options: [
        { key:"hrbp", label:"HRBPï¼ˆç®¡ç†é£æ ¼ï¼‰" },
        { key:"hiring_mgr", label:"å·¥å‚ç»ç†ï¼ˆäº§èƒ½&è´¨é‡ï¼‰" },
        { key:"exec", label:"è¿è¥æ€»ç›‘ï¼ˆæ•ˆç‡&å®‰å…¨ï¼‰" }
      ]
    }
  ];

  const INTERVIEWER_ROLE_TEXT = {
    hrbp: "HRBP",
    hiring_mgr: "ç”¨äººç»ç†",
    exec: "é«˜ç®¡/ä¸šåŠ¡è´Ÿè´£äºº"
  };

  // -----------------------------
  // State
  // -----------------------------
  let questions = [];                 // [{id, question, followup_seeds, what_good_looks_like, type}]
  let qIndex = -1;                    // current index in questions
  let followupCount = 0;              // per question
  let sessionStarted = false;

  // config gating: active vs pending (apply next question)
  let activeConfig = null;
  let pendingConfig = null;

  // -----------------------------
  // UI init
  // -----------------------------
  function fillRoleSelect(){
    const sel = $("roleSel");
    sel.innerHTML = "";
    ROLES.forEach(r=>{
      const opt = document.createElement("option");
      opt.value = r.key;
      opt.textContent = r.label;
      sel.appendChild(opt);
    });
  }

  function fillInterviewerSelect(roleKey){
    const role = ROLES.find(r=>r.key===roleKey) || ROLES[0];
    const sel = $("interviewerSel");
    sel.innerHTML = "";
    role.interviewer_options.forEach(o=>{
      const opt = document.createElement("option");
      opt.value = o.key;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });
    // default: hiring mgr
    sel.value = role.interviewer_options.find(x=>x.key==="hiring_mgr")?.key || role.interviewer_options[0].key;
  }

  function getConfigFromUI(){
    return {
      style: $("styleSel").value,     // friendly|pressure
      goal: $("goalSel").value,       // star|scenario|quant
      scene: $("sceneSel").value,     // interview_room...
      role_key: $("roleSel").value,
      role_label: ROLES.find(r=>r.key===$("roleSel").value)?.label || "å€™é€‰äºº",
      interviewer_type: $("interviewerSel").value // hrbp|hiring_mgr|exec
    };
  }

  function updateStage(){
    const cfg = getConfigFromUI();
    $("stage").dataset.scene = cfg.scene;

    const roleLabel = cfg.role_label;
    const interviewerType = cfg.interviewer_type;
    const interviewerName = `${INTERVIEWER_ROLE_TEXT[interviewerType] || "é¢è¯•å®˜"} Â· ${roleLabel}é¢`;

    $("nameMe").textContent = `ä½ ï¼ˆ${roleLabel}ï¼‰`;
    $("nameInterviewer").textContent = interviewerName;

    // style => stern
    setStern(cfg.style === "pressure");

    // pending hint
    refreshPendingHint();
  }

  function refreshPendingHint(){
    if(!sessionStarted){
      $("pendingHint").textContent = "æ— ";
      return;
    }
    const a = activeConfig || {};
    const p = pendingConfig || {};
    const diffs = [];
    if(a.style !== p.style) diffs.push("é£æ ¼");
    if(a.goal !== p.goal) diffs.push("ç›®æ ‡");
    if(a.scene !== p.scene) diffs.push("åœºæ™¯");
    if(a.interviewer_type !== p.interviewer_type) diffs.push("é¢è¯•å®˜");
    if(a.role_key !== p.role_key) diffs.push("å²—ä½");
    $("pendingHint").textContent = diffs.length ? (diffs.join("ã€") + "ï¼ˆä¸‹ä¸€é¢˜ç”Ÿæ•ˆï¼‰") : "æ— ";
  }

  // -----------------------------
  // Chat UI
  // -----------------------------
  let chatLog = [];
  function addMsg(role, text, coach=null){
    chatLog.push({ role, text, coach, when: nowStr() });
    renderChat();
  }

  function renderChat(){
    const box = $("chat");
    box.innerHTML = "";
    chatLog.forEach(m=>{
      const div = document.createElement("div");
      div.className = "msg " + (m.role === "me" ? "me" : "");
      div.innerHTML = `
        <div class="meta">
          <div class="who">${m.role === "me" ? "ä½ " : (m.role === "interviewer" ? "é¢è¯•å®˜" : "ç³»ç»Ÿ")}</div>
          <div class="when">${m.when || ""}</div>
        </div>
        <div class="txt"></div>
      `;
      div.querySelector(".txt").textContent = m.text || "";

      if(m.coach){
        const c = m.coach;
        const coach = document.createElement("div");
        coach.className = "coach";
        coach.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
            <div style="font-weight:900;font-size:12px">æ•™ç»ƒç‚¹è¯„</div>
            <span class="pill" style="border-color:rgba(15,23,42,.10);background:rgba(255,255,255,.72);color:var(--muted)"><strong style="color:var(--text)">æ€»åˆ†</strong> ${c.total_score ?? "-"} / 100</span>
          </div>
          <div class="bar"><i style="width:${Math.max(0, Math.min(100, c.total_score||0))}%"></i></div>
          <div class="scoreline"><span class="k">äº®ç‚¹ï¼š</span><span class="v">${c.strength || "-"}</span></div>
          <div class="scoreline"><span class="k">æ”¹è¿›ï¼š</span><span class="v">${c.improve || "-"}</span></div>
          <div class="scoreline"><span class="k">ç¤ºèŒƒï¼š</span><span class="v">${c.one_sentence_demo || "-"}</span></div>
        `;
        div.appendChild(coach);
      }

      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }

  // -----------------------------
  // Questions UI
  // -----------------------------
  function setQuestionsUI(){
    $("qTotal").textContent = questions.length ? String(questions.length) : "-";
    $("qIndex").textContent = (qIndex >= 0) ? String(qIndex + 1) : "-";
    const current = questions[qIndex]?.question || "å°šæœªå¼€å§‹";
    $("currentQuestion").textContent = current;

    const list = questions.map((q, i)=> `${i+1}. ${q.question}`).join("\n");
    $("questionList").value = list;

    $("btnNextQ").disabled = !(sessionStarted && questions.length && qIndex >= 0 && qIndex < questions.length - 1);
  }

  function gotoQuestion(idx){
    qIndex = idx;
    followupCount = 0;
    setQuestionsUI();

    const q = questions[qIndex]?.question;
    if(q){
      addMsg("interviewer", q);
      speakIfEnabled(q);
    }
  }

  // -----------------------------
  // API calls
  // -----------------------------
  async function apiCall(action, payload){
    const res = await fetch("/api/deepseek", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, payload })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || !data.ok){
      throw new Error(data.error || "è¯·æ±‚å¤±è´¥");
    }
    return data.data;
  }

  // -----------------------------
  // Session
  // -----------------------------
  async function startSession(){
    const cfg = getConfigFromUI();
    // active & pending both start as current config
    activeConfig = { ...cfg };
    pendingConfig = { ...cfg };
    refreshPendingHint();

    $("btnStart").disabled = true;
    $("btnNextQ").disabled = true;
    toast("æ­£åœ¨ç”Ÿæˆ 3-5 ä¸ªé¢è¯•é—®é¢˜...");

    try{
      const data = await apiCall("generate_questions", {
        role_key: cfg.role_key,
        role_label: cfg.role_label,
        interviewer_type: cfg.interviewer_type,
        style: cfg.style,
        goal: cfg.goal,
        scene: cfg.scene
      });

      questions = Array.isArray(data?.questions) ? data.questions : [];
      if(!questions.length){
        throw new Error("æœªç”Ÿæˆé—®é¢˜ï¼Œè¯·é‡è¯•");
      }

      sessionStarted = true;
      chatLog = [];

      updateStage();
      setQuestionsUI();

      const interviewerRole = data?.interviewer_role || INTERVIEWER_ROLE_TEXT[cfg.interviewer_type] || "é¢è¯•å®˜";
      addMsg("system", `é™ªç»ƒå¼€å§‹ï½œå²—ä½ï¼š${cfg.role_label}ï½œé¢è¯•å®˜ï¼š${interviewerRole}ï½œé£æ ¼ï¼š${cfg.style}ï½œç›®æ ‡ï¼š${cfg.goal}ï½œåœºæ™¯ï¼š${cfg.scene}`);

      qIndex = 0;
      followupCount = 0;
      setQuestionsUI();

      // ask first question (from generated list)
      const q0 = questions[0].question;
      addMsg("interviewer", q0);
      speakIfEnabled(q0);

      toast("å·²å¼€å§‹é™ªç»ƒ");
    }catch(err){
      console.error(err);
      toast("å¼€å§‹å¤±è´¥ï¼š" + err.message);
    }finally{
      $("btnStart").disabled = false;
      setQuestionsUI();
      refreshPendingHint();
    }
  }

  // apply pending config when entering next question
  function applyPendingIfNeeded(){
    const a = activeConfig || {};
    const p = pendingConfig || {};
    const changed = JSON.stringify(a) !== JSON.stringify(p);
    if(changed){
      activeConfig = { ...p };
      updateStage();
      refreshPendingHint();
      toast("å·²åº”ç”¨æ–°çš„é™ªç»ƒè®¾ç½®ï¼ˆä»æœ¬é¢˜å¼€å§‹ï¼‰");
    }
  }

  // -----------------------------
  // Turn handling
  // -----------------------------
  async function sendAnswer(){
    if(!sessionStarted || qIndex < 0 || qIndex >= questions.length){
      toast("è¯·å…ˆå¼€å§‹é™ªç»ƒ");
      return;
    }
    const answer = normalizeSpace($("answerText").value);
    if(!answer){
      toast("è¯·å…ˆè¯´/è¾“å…¥ä½ çš„å›ç­”");
      return;
    }

    addMsg("me", answer);
    $("btnSend").disabled = true;

    const cfgNow = activeConfig || getConfigFromUI();
    const cfgNext = pendingConfig || cfgNow;

    // build payload
    const payload = {
      active_config: cfgNow,
      pending_config: cfgNext,
      role_label: cfgNow.role_label,
      interviewer_type: cfgNow.interviewer_type,
      scene: cfgNow.scene,
      question_index: qIndex,
      followup_count: followupCount,
      questions,
      current_question: questions[qIndex],
      user_answer: answer,
      last_turn_brief: chatLog.slice(-6).map(x=>({role:x.role,text:x.text})),
      followup_limit: 2
    };

    try{
      toast("AI æ­£åœ¨è¿½é—®ä¸ç‚¹è¯„...");
      const data = await apiCall("interview_turn", payload);

      const interviewer = data?.interviewer_reply || "ï¼ˆæœªç”Ÿæˆé¢è¯•å®˜å›å¤ï¼‰";
      const coach = data?.coach_feedback || null;
      const nextStep = data?.next_step || "followup";
      const newIndex = Number.isFinite(data?.question_index) ? data.question_index : qIndex;

      // show reply
      addMsg("interviewer", interviewer, coach);
      speakIfEnabled(interviewer);

      // clear input
      $("answerText").value = "";

      if(nextStep === "followup"){
        followupCount = Math.min(followupCount + 1, 99);
        // if too many followups, force move
        if(followupCount > 2 && qIndex < questions.length - 1){
          toast("è¿½é—®å·²è¾¾ä¸Šé™ï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€é¢˜");
          applyPendingIfNeeded();
          gotoQuestion(qIndex + 1);
        }
      }else if(nextStep === "next_question"){
        // move to next question index suggested
        const target = Math.min(Math.max(newIndex, qIndex + 1), questions.length);
        if(target < questions.length){
          applyPendingIfNeeded();
          qIndex = target;
          followupCount = 0;
          setQuestionsUI();

          // If model already asked the next question in interviewer_reply, we won't duplicate.
          // But to keep UI consistent, we set currentQuestion to that next one.
          $("currentQuestion").textContent = questions[qIndex]?.question || interviewer;
          $("qIndex").textContent = String(qIndex + 1);

          $("btnNextQ").disabled = (qIndex >= questions.length - 1);
        }else{
          // out of range => wrap up
          sessionStarted = true;
          $("btnNextQ").disabled = true;
        }
      }else if(nextStep === "wrap_up"){
        $("btnNextQ").disabled = true;
        toast("æœ¬æ¬¡é™ªç»ƒå·²ç»“æŸ");
      }

      setQuestionsUI();
      refreshPendingHint();
    }catch(err){
      console.error(err);
      toast("è¯·æ±‚å¤±è´¥ï¼š" + err.message);
    }finally{
      $("btnSend").disabled = false;
    }
  }

  // manual skip to next question
  function skipToNextQuestion(){
    if(!sessionStarted || !questions.length) return;
    if(qIndex >= questions.length - 1){ toast("å·²ç»æ˜¯æœ€åä¸€é¢˜"); return; }
    applyPendingIfNeeded();
    qIndex = qIndex + 1;
    followupCount = 0;
    setQuestionsUI();
    const q = questions[qIndex].question;
    addMsg("interviewer", `ä¸‹ä¸€é¢˜ï¼š${q}`);
    speakIfEnabled(q);
  }

  // -----------------------------
  // Speech Recognition (Web Speech API) - no repeating
  // Use "hold to talk" to reduce duplication, plus overlap-dedup.
  // -----------------------------
  let recognition = null;
  let recognizing = false;
  let baseManual = "";
  let finalTranscript = "";
  let interimTranscript = "";

  function setupSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šå½“å‰æµè§ˆå™¨ä¸æ”¯æŒï¼ˆè¯·æ‰‹åŠ¨è¾“å…¥ï¼‰";
      $("btnHoldTalk").disabled = true;
      $("btnStop").disabled = true;
      return;
    }
    recognition = new SR();
    recognition.lang = "zh-CN";
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onstart = ()=>{
      recognizing = true;
      setMeLive(true);
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šè¿›è¡Œä¸­â€¦ï¼ˆæ¾å¼€/ç‚¹å‡»åœæ­¢ç»“æŸï¼‰";
      $("btnStop").disabled = false;

      // lock textarea while recording (prevents user edits being overwritten)
      $("answerText").readOnly = true;

      // snapshot existing manual input as prefix
      baseManual = normalizeSpace($("answerText").value);
      finalTranscript = "";
      interimTranscript = "";
      $("dotMe").classList.add("live");
      $("avatarMe").classList.add("talking");
    };

    recognition.onerror = (e)=>{
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šé”™è¯¯ " + (e.error || "");
      recognizing = false;
      setMeLive(false);
      $("btnStop").disabled = true;
      $("answerText").readOnly = false;
      $("avatarMe").classList.remove("talking");
    };

    recognition.onend = ()=>{
      recognizing = false;
      setMeLive(false);
      $("sttHint").textContent = "è¯­éŸ³è¯†åˆ«ï¼šå·²åœæ­¢ï¼ˆå¯ç¼–è¾‘åå‘é€ï¼‰";
      $("btnStop").disabled = true;
      $("answerText").readOnly = false;
      $("avatarMe").classList.remove("talking");

      // finalize: drop interim to avoid duplication
      interimTranscript = "";
      const text = normalizeSpace([baseManual, finalTranscript].filter(Boolean).join(" "));
      $("answerText").value = text;

      if($("autoSendToggle").checked){
        if(text) sendAnswer();
      }
    };

    recognition.onresult = (e)=>{
      let interimParts = [];
      for(let i = e.resultIndex; i < e.results.length; i++){
        const t = normalizeSpace(e.results[i][0].transcript);
        if(!t) continue;
        if(e.results[i].isFinal){
          finalTranscript = appendWithOverlap(finalTranscript, t);
        }else{
          interimParts.push(t);
        }
      }
      interimTranscript = normalizeSpace(interimParts.join(" "));
      const combined = normalizeSpace([baseManual, finalTranscript, interimTranscript].filter(Boolean).join(" "));
      $("answerText").value = combined;
    };
  }

  function startSTT(){
    if(!recognition) return;
    try{ recognition.start(); }catch(e){}
  }
  function stopSTT(){
    if(!recognition) return;
    try{ recognition.stop(); }catch(e){}
  }

  // Hold-to-talk: pointer down/up
  function bindHoldToTalk(){
    const btn = $("btnHoldTalk");

    const down = (e)=>{
      e.preventDefault();
      if(!recognition) return;
      if(recognizing) return;
      startSTT();
    };
    const up = (e)=>{
      e.preventDefault();
      if(!recognition) return;
      if(!recognizing) return;
      stopSTT();
    };

    btn.addEventListener("pointerdown", down);
    btn.addEventListener("pointerup", up);
    btn.addEventListener("pointercancel", up);
    btn.addEventListener("pointerleave", (e)=>{ if(recognizing) up(e); });

    // fallback click (desktop)
    btn.addEventListener("click", (e)=>{
      // do nothing (pointer handlers already)
    });

    $("btnStop").addEventListener("click", (e)=>{
      e.preventDefault();
      if(recognizing) stopSTT();
    });
  }

  // -----------------------------
  // Events
  // -----------------------------
  $("btnStart").addEventListener("click", startSession);
  $("btnSend").addEventListener("click", sendAnswer);
  $("btnNextQ").addEventListener("click", skipToNextQuestion);

  $("btnResetAll").addEventListener("click", ()=>{
    questions = [];
    qIndex = -1;
    followupCount = 0;
    sessionStarted = false;
    chatLog = [];
    activeConfig = null;
    pendingConfig = null;
    $("answerText").value = "";
    $("questionList").value = "";
    $("currentQuestion").textContent = "å°šæœªå¼€å§‹";
    $("qIndex").textContent = "-";
    $("qTotal").textContent = "-";
    $("btnNextQ").disabled = true;
    $("pendingHint").textContent = "æ— ";
    renderChat();
    updateStage();
    toast("å·²é‡ç½®");
  });

  // role change updates interviewer options
  $("roleSel").addEventListener("change", ()=>{
    fillInterviewerSelect($("roleSel").value);
    updateStage();
    onConfigChange();
  });

  // scene change updates stage immediately (visual)
  $("sceneSel").addEventListener("change", ()=>{
    updateStage();
    onConfigChange();
  });

  $("interviewerSel").addEventListener("change", ()=>{
    updateStage();
    onConfigChange();
  });

  $("styleSel").addEventListener("change", ()=>{
    updateStage();
    onConfigChange();
  });

  $("goalSel").addEventListener("change", ()=>{
    updateStage();
    onConfigChange();
  });

  function onConfigChange(){
    const cfg = getConfigFromUI();
    if(!sessionStarted){
      // before session, no pending gating
      activeConfig = null;
      pendingConfig = null;
      refreshPendingHint();
      return;
    }
    // during session: update pending only
    pendingConfig = { ...pendingConfig, ...cfg };
    refreshPendingHint();
  }

  // -----------------------------
  // init
  // -----------------------------
  (function init(){
    fillRoleSelect();
    fillInterviewerSelect(ROLES[0].key);
    setupSTT();
    bindHoldToTalk();
    updateStage();
    renderChat();
  })();
</script>
</body>
</html>
